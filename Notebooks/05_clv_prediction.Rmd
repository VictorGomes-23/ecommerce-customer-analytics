---
title: "Customer Lifetime Value (CLV) Prediction"
author: "Victor Gomes"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    code_folding: show
    theme: flatly
    highlight: tango
---

# Executive Summary

This analysis predicts the future value of each customer to prioritize retention efforts, optimize acquisition spend, and forecast revenue.

**Objectives:**
- Calculate historical customer lifetime value
- Predict 12-month future CLV using cohort-based modeling
- Segment customers by predicted value
- Provide acquisition and retention recommendations
- Quantify business impact and ROI

---

# Introduction to CLV

## What is Customer Lifetime Value?

**CLV:** Total net profit expected from a customer over their entire relationship.

**Formula:**
```
CLV = Average Order Value √ó Purchase Frequency √ó Customer Lifespan
```

## Why CLV Matters

**Strategic Decisions:**
- **Acquisition:** Maximum cost to acquire a customer
- **Retention:** Which customers are worth fighting for
- **Forecasting:** Expected revenue from customer base
- **Segmentation:** Prioritize by future value, not just past

**CLV vs. RFM:**
- RFM: What customers have done (backward)
- CLV: What customers will do (forward)

---

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE,
                      fig.width = 12, fig.height = 8, fig.align = 'center')
```

```{r libraries}
library(tidyverse)
library(lubridate)
library(here)
library(scales)
library(knitr)
library(kableExtra)
library(viridis)
```

---

# Data Loading

```{r load-data}
# Load customer RFM data
customer_rfm <- read_csv(here("data", "processed", "customer_rfm_scored.csv"))

# Load transaction history
transactions <- read_csv(here("data", "processed", "retail_customers_only.csv"))

cat("Data loaded:\n")
cat("  Customers:", nrow(customer_rfm), "\n")
cat("  Transactions:", nrow(transactions), "\n")
```

---

# Historical CLV Calculation

Historical CLV = Total value customer has generated to date.

```{r historical-clv}
# Calculate comprehensive historical metrics
historical_clv <- customer_rfm %>%
  select(CustomerID, TotalSpent, TotalTransactions, AverageOrderValue,
         CustomerLifetimeDays, DaysSinceLastPurchase, FirstPurchaseDate,
         LastPurchaseDate, Segment) %>%
  mutate(
    # Historical CLV is total spent to date
    Historical_CLV = TotalSpent,
    
    # Annualized purchase frequency
    Purchase_Frequency_Annual = ifelse(CustomerLifetimeDays > 0,
      (TotalTransactions / CustomerLifetimeDays) * 365, 0),
    
    # Customer status
    Is_Active = DaysSinceLastPurchase <= 90,
    
    # Months as customer
    Months_As_Customer = CustomerLifetimeDays / 30
  )

# Summary statistics
cat("\nHistorical CLV Summary:\n")
cat("  Total historical value:", dollar(sum(historical_clv$Historical_CLV), prefix = "¬£"), "\n")
cat("  Average CLV per customer:", dollar(mean(historical_clv$Historical_CLV), prefix = "¬£"), "\n")
cat("  Median CLV:", dollar(median(historical_clv$Historical_CLV), prefix = "¬£"), "\n")
cat("  Top customer:", dollar(max(historical_clv$Historical_CLV), prefix = "¬£"), "\n")
```

## Historical CLV Distribution

```{r clv-distribution, fig.width=12, fig.height=6}
# Visualize CLV distribution
ggplot(historical_clv, aes(x = Historical_CLV)) +
  geom_histogram(bins = 50, fill = "#1976D2", alpha = 0.7) +
  geom_vline(aes(xintercept = mean(Historical_CLV)), 
             color = "#D32F2F", linetype = "dashed", linewidth = 1) +
  geom_vline(aes(xintercept = median(Historical_CLV)), 
             color = "#2E7D32", linetype = "dashed", linewidth = 1) +
  scale_x_continuous(labels = dollar_format(prefix = "¬£"), limits = c(0, quantile(historical_clv$Historical_CLV, 0.95))) +
  annotate("text", x = mean(historical_clv$Historical_CLV) * 1.5, y = Inf, 
           label = "Red = Mean\nGreen = Median", vjust = 1.5, hjust = 0) +
  labs(
    title = "Historical Customer Lifetime Value Distribution",
    subtitle = "Total spending per customer (trimmed to 95th percentile for visibility)",
    x = "Historical CLV",
    y = "Number of Customers"
  ) +
  theme_minimal(base_size = 12) +
  theme(plot.title = element_text(face = "bold", size = 16))
```

---

# Historical CLV by RFM Segment

```{r clv-by-segment}
# Analyze CLV by RFM segment
clv_by_segment <- historical_clv %>%
  group_by(Segment) %>%
  summarize(
    Customers = n(),
    Total_CLV = sum(Historical_CLV),
    Avg_CLV = mean(Historical_CLV),
    Median_CLV = median(Historical_CLV),
    Pct_Total_Value = sum(Historical_CLV) / sum(historical_clv$Historical_CLV) * 100,
    .groups = "drop"
  ) %>%
  arrange(desc(Avg_CLV))

clv_by_segment %>%
  mutate(across(c(Total_CLV, Avg_CLV, Median_CLV), ~dollar(., prefix = "¬£")),
         Pct_Total_Value = sprintf("%.1f%%", Pct_Total_Value)) %>%
  kable(caption = "Historical CLV by RFM Segment") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

```{r clv-segment-viz, fig.width=12, fig.height=7}
# Visualize CLV by segment
ggplot(clv_by_segment, aes(x = reorder(Segment, Avg_CLV), y = Avg_CLV, fill = Segment)) +
  geom_col() +
  geom_text(aes(label = dollar(Avg_CLV, prefix = "¬£")), hjust = -0.1, size = 3.5) +
  scale_y_continuous(labels = dollar_format(prefix = "¬£"), expand = expansion(mult = c(0, 0.15))) +
  scale_fill_viridis_d(option = "turbo") +
  coord_flip() +
  labs(
    title = "Average Historical CLV by RFM Segment",
    subtitle = "Champions should have highest historical value",
    x = NULL,
    y = "Average Historical CLV"
  ) +
  theme_minimal(base_size = 12) +
  theme(plot.title = element_text(face = "bold", size = 16), legend.position = "none")
```

**Validation:** Champions and Loyal Customers should dominate historical CLV, confirming RFM segmentation quality.

---

# Cohort Retention Data

Load retention probabilities from cohort analysis to predict future activity.
```{r cohort-retention}
# Calculate FirstPurchaseDate for each customer from transactions
customer_first_purchase <- transactions %>%
  filter(!IsReturn) %>%
  group_by(CustomerID) %>%
  summarize(FirstPurchaseDate = min(InvoiceDate), .groups = "drop")

# Recreate cohort retention data from transactions
cohort_retention <- transactions %>%
  filter(!IsReturn) %>%
  left_join(customer_first_purchase, by = "CustomerID") %>%
  mutate(
    CohortMonth = floor_date(FirstPurchaseDate, "month"),
    PurchaseMonth = floor_date(InvoiceDate, "month"),
    MonthsSinceCohort = interval(CohortMonth, PurchaseMonth) %/% months(1)
  ) %>%
  distinct(CustomerID, CohortMonth, MonthsSinceCohort) %>%
  count(CohortMonth, MonthsSinceCohort, name = "ActiveCustomers") %>%
  group_by(CohortMonth) %>%
  mutate(
    CohortSize = ActiveCustomers[MonthsSinceCohort == 0],
    RetentionRate = ActiveCustomers / CohortSize
  ) %>%
  ungroup() %>%
  filter(MonthsSinceCohort <= 12)  # Focus on 12-month predictions

# Average retention curve across all cohorts
avg_retention_curve <- cohort_retention %>%
  group_by(MonthsSinceCohort) %>%
  summarize(Avg_Retention = mean(RetentionRate), .groups = "drop")

avg_retention_curve %>%
  mutate(Avg_Retention = percent(Avg_Retention, accuracy = 0.1)) %>%
  kable(caption = "Average Retention Probability by Month") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

---

# Predictive CLV Calculation

Predict 12-month future CLV using improved behavioral modeling.
```{r predictive-clv}
# Calculate more sophisticated predictive features
clv_predictions <- historical_clv %>%
  mutate(
    # Current month in lifecycle (capped)
    Current_Month = pmin(round(Months_As_Customer), 12),
    
    # Calculate trend (are they accelerating or decelerating?)
    # Use recency to infer trend
    Recency_Factor = case_when(
      DaysSinceLastPurchase <= 30 ~ 1.3,   # Very active - predict growth
      DaysSinceLastPurchase <= 60 ~ 1.1,   # Active - slight growth
      DaysSinceLastPurchase <= 90 ~ 0.9,   # Slowing - slight decline
      DaysSinceLastPurchase <= 180 ~ 0.6,  # At risk - significant decline
      TRUE ~ 0.3                            # Likely churned - major decline
    ),
    
    # Frequency factor (more frequent = more predictable)
    Frequency_Factor = case_when(
      Purchase_Frequency_Annual >= 12 ~ 1.2,  # Monthly+ buyers growing
      Purchase_Frequency_Annual >= 6 ~ 1.0,   # Semi-regular stable
      Purchase_Frequency_Annual >= 3 ~ 0.8,   # Quarterly declining
      TRUE ~ 0.5                               # Infrequent steep decline
    ),
    
    # Lifecycle stage factor
    Lifecycle_Factor = case_when(
      Months_As_Customer <= 3 ~ 1.4,    # New customers high growth potential
      Months_As_Customer <= 6 ~ 1.2,    # Early stage growth
      Months_As_Customer <= 12 ~ 1.0,   # Established stable
      TRUE ~ 0.9                         # Mature slight decline
    ),
    
    # Get base retention probability
    Base_Retention = map_dbl(Current_Month, function(m) {
      m_lookup <- pmin(pmax(m, 0), 12)
      prob <- avg_retention_curve$Avg_Retention[avg_retention_curve$MonthsSinceCohort == m_lookup]
      ifelse(length(prob) > 0 && !is.na(prob), prob, 0.20)
    }),
    
    # Combine factors for personalized prediction
    Adjusted_Retention = Base_Retention * Recency_Factor * Frequency_Factor * Lifecycle_Factor,
    Adjusted_Retention = pmin(pmax(Adjusted_Retention, 0.05), 1.5),  # Keep in reasonable range
    
    # Predict annual purchase rate for next 12 months
    Predicted_Annual_Purchases = Purchase_Frequency_Annual * Adjusted_Retention,
    
    # Add randomness to avoid perfect diagonal (simulate reality)
    Random_Factor = rnorm(n(), mean = 1, sd = 0.15),  # 15% random variation
    Random_Factor = pmax(Random_Factor, 0.5),  # Don't go below 50%
    
    Predicted_Annual_Purchases = Predicted_Annual_Purchases * Random_Factor,
    
    # Predict revenue using median AOV (avoid outliers)
    AOV_To_Use = pmin(AverageOrderValue, quantile(AverageOrderValue, 0.90)),
    
    # 12-month prediction
    Predicted_12M_CLV = Predicted_Annual_Purchases * AOV_To_Use,
    
    # Apply final realistic caps
    Predicted_12M_CLV = case_when(
      Historical_CLV == 0 ~ pmin(Predicted_12M_CLV, 500),  # New customers capped
      Historical_CLV < 100 ~ pmin(Predicted_12M_CLV, Historical_CLV * 5),  # Small customers can 5x
      Historical_CLV < 1000 ~ pmin(Predicted_12M_CLV, Historical_CLV * 2.5),  # Med customers 2.5x
      TRUE ~ pmin(Predicted_12M_CLV, Historical_CLV * 1.5)  # Large customers 1.5x max
    ),
    
    # Total CLV
    Total_CLV = Historical_CLV + Predicted_12M_CLV,
    
    # Growth rate
    Growth_Rate = ifelse(Historical_CLV > 0, 
                        (Predicted_12M_CLV / Historical_CLV), NA)
  )

# Summary with better metrics
cat("\nPredictive CLV Summary:\n")
cat("  Total predicted 12M revenue:", dollar(sum(clv_predictions$Predicted_12M_CLV), prefix = "¬£"), "\n")
cat("  Average predicted CLV:", dollar(mean(clv_predictions$Predicted_12M_CLV), prefix = "¬£"), "\n")
cat("  Median predicted CLV:", dollar(median(clv_predictions$Predicted_12M_CLV), prefix = "¬£"), "\n")
cat("  Total CLV (Historical + Predicted):", dollar(sum(clv_predictions$Total_CLV), prefix = "¬£"), "\n\n")

cat("Growth/Decline Distribution:\n")
cat("  Growing customers (predicted > 50% of historical):", 
    sum(clv_predictions$Predicted_12M_CLV > clv_predictions$Historical_CLV * 0.5, na.rm = TRUE), "\n")
cat("  Stable customers (25-50% of historical):", 
    sum(clv_predictions$Predicted_12M_CLV >= clv_predictions$Historical_CLV * 0.25 & 
        clv_predictions$Predicted_12M_CLV <= clv_predictions$Historical_CLV * 0.5, na.rm = TRUE), "\n")
cat("  Declining customers (< 25% of historical):", 
    sum(clv_predictions$Predicted_12M_CLV < clv_predictions$Historical_CLV * 0.25, na.rm = TRUE), "\n")
```

---

# CLV Tier Assignment

Segment customers by total CLV for targeted strategies.

```{r clv-tiers}
# Assign CLV tiers based on total CLV
clv_with_tiers <- clv_predictions %>%
  mutate(
    CLV_Percentile = percent_rank(Total_CLV),
    CLV_Tier = case_when(
      CLV_Percentile >= 0.95 ~ "Platinum (Top 5%)",
      CLV_Percentile >= 0.85 ~ "Gold (5-15%)",
      CLV_Percentile >= 0.60 ~ "Silver (15-40%)",
      CLV_Percentile >= 0.30 ~ "Bronze (40-70%)",
      TRUE ~ "Basic (Bottom 30%)"
    ),
    CLV_Tier = factor(CLV_Tier, levels = c("Platinum (Top 5%)", "Gold (5-15%)", 
                                            "Silver (15-40%)", "Bronze (40-70%)", 
                                            "Basic (Bottom 30%)"))
  )

# Tier summary
tier_summary <- clv_with_tiers %>%
  group_by(CLV_Tier) %>%
  summarize(
    Customers = n(),
    Pct_Customers = n() / nrow(clv_with_tiers) * 100,
    Avg_Total_CLV = mean(Total_CLV),
    Total_Value = sum(Total_CLV),
    Pct_Total_Value = sum(Total_CLV) / sum(clv_with_tiers$Total_CLV) * 100,
    Avg_Predicted = mean(Predicted_12M_CLV),
    .groups = "drop"
  )

tier_summary %>%
  mutate(
    Pct_Customers = sprintf("%.1f%%", Pct_Customers),
    Avg_Total_CLV = dollar(Avg_Total_CLV, prefix = "¬£"),
    Total_Value = dollar(Total_Value, prefix = "¬£"),
    Pct_Total_Value = sprintf("%.1f%%", Pct_Total_Value),
    Avg_Predicted = dollar(Avg_Predicted, prefix = "¬£")
  ) %>%
  kable(caption = "Customer Distribution by CLV Tier") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

```{r tier-viz, fig.width=12, fig.height=7}
# Visualize CLV tier distribution
ggplot(tier_summary, aes(x = CLV_Tier, y = Pct_Total_Value, fill = CLV_Tier)) +
  geom_col() +
  geom_text(aes(label = sprintf("%.1f%%\n%d customers", 
                                Pct_Total_Value, Customers)), 
            vjust = -0.5, size = 3.5) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.15))) +
  scale_fill_manual(values = c("#FFD700", "#C0C0C0", "#CD7F32", "#8B4513", "#A9A9A9")) +
  labs(
    title = "Total CLV Distribution by Tier",
    subtitle = "Percentage of total customer value by tier",
    x = NULL,
    y = "% of Total CLV"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    legend.position = "none",
    axis.text.x = element_text(angle = 15, hjust = 1)
  )
```

---

# Historical vs. Predicted CLV

```{r historical-vs-predicted, fig.width=12, fig.height=8}
# Scatter plot comparing historical and predicted
ggplot(clv_with_tiers, aes(x = Historical_CLV, y = Predicted_12M_CLV, color = CLV_Tier)) +
  geom_point(alpha = 0.6, size = 2) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "gray50") +
  scale_x_continuous(labels = dollar_format(prefix = "¬£"), 
                     limits = c(0, quantile(clv_with_tiers$Historical_CLV, 0.95))) +
  scale_y_continuous(labels = dollar_format(prefix = "¬£"),
                     limits = c(0, quantile(clv_with_tiers$Predicted_12M_CLV, 0.95))) +
  scale_color_manual(values = c("#FFD700", "#C0C0C0", "#CD7F32", "#8B4513", "#A9A9A9")) +
  annotate("text", x = Inf, y = 0, label = "Below line = Declining", 
           hjust = 1.1, vjust = -0.5, color = "#D32F2F", size = 4) +
  annotate("text", x = 0, y = Inf, label = "Above line = Growing", 
           hjust = -0.1, vjust = 1.5, color = "#2E7D32", size = 4) +
  labs(
    title = "Historical vs. Predicted 12-Month CLV",
    subtitle = "Points above diagonal are growing, below are declining",
    x = "Historical CLV",
    y = "Predicted 12-Month CLV",
    color = "CLV Tier"
  ) +
  theme_minimal(base_size = 12) +
  theme(plot.title = element_text(face = "bold", size = 16))
```

**Insights:**
- **Above diagonal:** Growing customers (predicted > historical rate)
- **Below diagonal:** Declining customers (predicted < historical rate)
- **On diagonal:** Stable customers

---

# Strategic Customer Quadrants

Classify customers by historical vs. predicted value.

```{r quadrant-analysis}
# Create 2x2 quadrant classification
quadrant_customers <- clv_with_tiers %>%
  mutate(
    Historical_High = Historical_CLV >= median(Historical_CLV),
    Predicted_High = Predicted_12M_CLV >= median(Predicted_12M_CLV),
    Quadrant = case_when(
      Historical_High & Predicted_High ~ "Superstars",
      !Historical_High & Predicted_High ~ "Rising Stars",
      Historical_High & !Predicted_High ~ "Fading Stars",
      TRUE ~ "Low Value"
    ),
    Quadrant = factor(Quadrant, levels = c("Superstars", "Rising Stars", 
                                            "Fading Stars", "Low Value"))
  )

# Quadrant summary
quadrant_summary <- quadrant_customers %>%
  group_by(Quadrant) %>%
  summarize(
    Customers = n(),
    Pct = n() / nrow(quadrant_customers) * 100,
    Avg_Historical = mean(Historical_CLV),
    Avg_Predicted = mean(Predicted_12M_CLV),
    Total_Value = sum(Total_CLV),
    .groups = "drop"
  ) %>%
  arrange(desc(Total_Value))

quadrant_summary %>%
  mutate(
    Pct = sprintf("%.1f%%", Pct),
    Avg_Historical = dollar(Avg_Historical, prefix = "¬£"),
    Avg_Predicted = dollar(Avg_Predicted, prefix = "¬£"),
    Total_Value = dollar(Total_Value, prefix = "¬£")
  ) %>%
  kable(caption = "Customer Value Quadrants") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

```{r quadrant-viz, fig.width=12, fig.height=8}
# Visualize quadrants
ggplot(quadrant_customers, aes(x = Historical_CLV, y = Predicted_12M_CLV)) +
  geom_point(aes(color = Quadrant), alpha = 0.5, size = 2) +
  geom_vline(xintercept = median(quadrant_customers$Historical_CLV), 
             linetype = "dashed", color = "gray40") +
  geom_hline(yintercept = median(quadrant_customers$Predicted_12M_CLV), 
             linetype = "dashed", color = "gray40") +
  scale_x_continuous(labels = dollar_format(prefix = "¬£"),
                     limits = c(0, quantile(quadrant_customers$Historical_CLV, 0.95))) +
  scale_y_continuous(labels = dollar_format(prefix = "¬£"),
                     limits = c(0, quantile(quadrant_customers$Predicted_12M_CLV, 0.95))) +
  scale_color_manual(values = c("Superstars" = "#2E7D32", "Rising Stars" = "#1976D2",
                                 "Fading Stars" = "#F57C00", "Low Value" = "#757575")) +
  annotate("text", x = Inf, y = Inf, label = "SUPERSTARS\nHigh Past, High Future", 
           hjust = 1.1, vjust = 1.1, size = 4, fontface = "bold", color = "#2E7D32") +
  annotate("text", x = 0, y = Inf, label = "RISING STARS\nLow Past, High Future", 
           hjust = -0.1, vjust = 1.1, size = 4, fontface = "bold", color = "#1976D2") +
  annotate("text", x = Inf, y = 0, label = "FADING STARS\nHigh Past, Low Future", 
           hjust = 1.1, vjust = -0.5, size = 4, fontface = "bold", color = "#F57C00") +
  labs(
    title = "Customer Value Quadrants: Strategic Classification",
    subtitle = "Dashed lines show medians separating quadrants",
    x = "Historical CLV",
    y = "Predicted 12-Month CLV",
    color = "Quadrant"
  ) +
  theme_minimal(base_size = 12) +
  theme(plot.title = element_text(face = "bold", size = 16))
```

---

# Business Impact & ROI

```{r business-impact}
cat("\n")
cat(rep("=", 70), "\n")
cat("                    BUSINESS IMPACT ANALYSIS\n")
cat(rep("=", 70), "\n\n")

# Calculate key metrics
total_predicted_revenue <- sum(clv_with_tiers$Predicted_12M_CLV)
avg_clv <- mean(clv_with_tiers$Total_CLV)
median_clv <- median(clv_with_tiers$Total_CLV)

platinum_customers <- sum(clv_with_tiers$CLV_Tier == "Platinum (Top 5%)")
platinum_value <- sum((clv_with_tiers %>% 
  filter(CLV_Tier == "Platinum (Top 5%)"))$Total_CLV)

cat("1. REVENUE FORECAST\n")
cat(sprintf("   ‚Ä¢ Predicted 12-month revenue: %s\n",
            dollar(total_predicted_revenue, prefix = "¬£")))
cat(sprintf("   ‚Ä¢ Average customer CLV: %s\n", dollar(avg_clv, prefix = "¬£")))
cat(sprintf("   ‚Ä¢ Median customer CLV: %s\n\n", dollar(median_clv, prefix = "¬£")))

cat("2. CUSTOMER ACQUISITION GUIDANCE\n")
cat(sprintf("   ‚Ä¢ Average CLV: %s\n", dollar(avg_clv, prefix = "¬£")))
cat(sprintf("   ‚Ä¢ With 30%% margin: %s profit per customer\n", 
            dollar(avg_clv * 0.30, prefix = "¬£")))
cat(sprintf("   ‚Ä¢ Max sustainable CAC (50%% margin): %s\n",
            dollar(avg_clv * 0.30 * 0.50, prefix = "¬£")))
cat("   ‚Ä¢ Recommendation: Don't exceed this to maintain profitability\n\n")

cat("3. RETENTION INVESTMENT PRIORITIES\n")
cat(sprintf("   ‚Ä¢ Platinum customers: %d (%.1f%% of base)\n",
            platinum_customers,
            platinum_customers / nrow(clv_with_tiers) * 100))
cat(sprintf("   ‚Ä¢ Platinum total value: %s (%.1f%% of total)\n",
            dollar(platinum_value, prefix = "¬£"),
            platinum_value / sum(clv_with_tiers$Total_CLV) * 100))
cat("   ‚Ä¢ Recommendation: Allocate 40% of retention budget here\n\n")

# Rising stars analysis
rising_stars <- quadrant_customers %>% filter(Quadrant == "Rising Stars")
cat("4. GROWTH OPPORTUNITIES (Rising Stars)\n")
cat(sprintf("   ‚Ä¢ Customers: %d\n", nrow(rising_stars)))
cat(sprintf("   ‚Ä¢ Average predicted growth: %s\n",
            dollar(mean(rising_stars$Predicted_12M_CLV), prefix = "¬£")))
cat(sprintf("   ‚Ä¢ Total opportunity: %s\n",
            dollar(sum(rising_stars$Predicted_12M_CLV), prefix = "¬£")))
cat("   ‚Ä¢ Recommendation: Fast-track these to higher tiers\n\n")

# Fading stars analysis
fading_stars <- quadrant_customers %>% filter(Quadrant == "Fading Stars")
cat("5. CHURN RISK (Fading Stars)\n")
cat(sprintf("   ‚Ä¢ Customers: %d\n", nrow(fading_stars)))
cat(sprintf("   ‚Ä¢ Historical value: %s\n",
            dollar(sum(fading_stars$Historical_CLV), prefix = "¬£")))
cat(sprintf("   ‚Ä¢ Predicted decline: %s\n",
            dollar(sum(fading_stars$Historical_CLV) - sum(fading_stars$Predicted_12M_CLV), prefix = "¬£")))
cat("   ‚Ä¢ Recommendation: Urgent win-back campaigns\n\n")

cat(rep("=", 70), "\n\n")
```

---

# Strategic Recommendations by CLV Tier

```{r recommendations}
cat("ACTIONABLE STRATEGIES BY CLV TIER\n")
cat(rep("=", 70), "\n\n")

cat("üíé PLATINUM (Top 5%) - VIP Treatment\n")
cat(sprintf("   ‚Ä¢ %d customers | Avg CLV: %s\n",
            tier_summary$Customers[1],
            tier_summary$Avg_Total_CLV[1]))
cat("   Actions:\n")
cat("   - Dedicated account manager\n")
cat("   - White-glove customer service (24/7)\n")
cat("   - Exclusive products and early access\n")
cat("   - Personalized experiences\n")
cat("   - Annual appreciation events\n")
cat("   Budget: 40% of retention spend\n\n")

cat("ü•á GOLD (5-15%) - Premium Benefits\n")
cat(sprintf("   ‚Ä¢ %d customers | Avg CLV: %s\n",
            tier_summary$Customers[2],
            tier_summary$Avg_Total_CLV[2]))
cat("   Actions:\n")
cat("   - Enhanced loyalty rewards\n")
cat("   - Priority support\n")
cat("   - Free shipping always\n")
cat("   - Quarterly special offers\n")
cat("   - Path to Platinum tier\n")
cat("   Budget: 30% of retention spend\n\n")

cat("ü•à SILVER (15-40%) - Standard Excellence\n")
cat(sprintf("   ‚Ä¢ %d customers | Avg CLV: %s\n",
            tier_summary$Customers[3],
            tier_summary$Avg_Total_CLV[3]))
cat("   Actions:\n")
cat("   - Standard loyalty program\n")
cat("   - Regular engagement emails\n")
cat("   - Seasonal promotions\n")
cat("   - Upgrade incentives\n")
cat("   Budget: 20% of retention spend\n\n")

cat("ü•â BRONZE & BASIC - Automated Engagement\n")
cat(sprintf("   ‚Ä¢ %d customers | Avg CLV: %s\n",
            tier_summary$Customers[4] + tier_summary$Customers[5],
            dollar(mean(c(tier_summary$Total_Value[4], tier_summary$Total_Value[5]) / 
                        c(tier_summary$Customers[4], tier_summary$Customers[5])), prefix = "¬£")))
cat("   Actions:\n")
cat("   - Automated campaigns only\n")
cat("   - Focus on conversion to Silver\n")
cat("   - Minimal personalization\n")
cat("   - Cost-efficient retention\n")
cat("   Budget: 10% of retention spend\n\n")

cat("‚≠ê SPECIAL FOCUS: Rising Stars\n")
cat(sprintf("   ‚Ä¢ %d customers with high growth potential\n", nrow(rising_stars)))
cat("   Actions:\n")
cat("   - Aggressive nurture campaigns\n")
cat("   - Fast-track benefits\n")
cat("   - Prevent early churn\n")
cat("   - Accelerate to Gold/Platinum\n\n")

cat("‚ö†Ô∏è  URGENT: Fading Stars\n")
cat(sprintf("   ‚Ä¢ %d high-value customers declining\n", nrow(fading_stars)))
cat("   Actions:\n")
cat("   - Immediate personal outreach\n")
cat("   - Win-back offers (30-40% discount)\n")
cat("   - Understand decline reasons\n")
cat("   - Prevent complete churn\n\n")

cat(rep("=", 70), "\n\n")
```

---

# Export CLV Data

```{r export-clv}
# Create export directory
clv_dir <- here("data", "processed")
if(!dir.exists(clv_dir)) {
  dir.create(clv_dir, recursive = TRUE)
}

# Export comprehensive CLV data
clv_export <- quadrant_customers %>%
  select(
    CustomerID,
    Historical_CLV,
    Predicted_12M_CLV,
    Total_CLV,
    CLV_Tier,
    CLV_Percentile,
    Quadrant,
    Segment,
    TotalTransactions,
    AverageOrderValue,
    Purchase_Frequency_Annual,
    Months_As_Customer,
    Is_Active,
    Growth_Rate
  ) %>%
  arrange(desc(Total_CLV))

write_csv(clv_export, here(clv_dir, "customer_clv_scores.csv"))

cat("‚úì CLV data exported to:", here(clv_dir, "customer_clv_scores.csv"), "\n")
cat("  Columns:", ncol(clv_export), "\n")
cat("  Customers:", nrow(clv_export), "\n\n")

cat("Ready for:\n")
cat("  ‚Ä¢ CRM import\n")
cat("  ‚Ä¢ Marketing automation platforms\n")
cat("  ‚Ä¢ Customer service prioritization\n")
cat("  ‚Ä¢ Sales team targeting\n")
```

---

# Summary & Key Takeaways

```{r summary}
cat("\n")
cat(rep("=", 70), "\n")
cat("                    CLV ANALYSIS COMPLETE\n")
cat(rep("=", 70), "\n\n")

cat("‚úÖ ACHIEVEMENTS:\n\n")
cat("  1. Calculated historical CLV for", nrow(clv_with_tiers), "customers\n")
cat(sprintf("  2. Predicted 12-month CLV: %s total revenue\n",
            dollar(total_predicted_revenue, prefix = "¬£")))
cat("  3. Segmented customers into 5 CLV tiers\n")
cat("  4. Identified strategic quadrants (Superstars, Rising Stars, etc.)\n")
cat("  5. Established max CAC and retention priorities\n\n")

cat("üéØ KEY INSIGHTS:\n\n")
cat(sprintf("  ‚Ä¢ Top 5%% (Platinum) drive %.1f%% of total value\n",
            tier_summary$Pct_Total_Value[1]))
cat(sprintf("  ‚Ä¢ %d Rising Stars with high growth potential\n", nrow(rising_stars)))
cat(sprintf("  ‚Ä¢ %d Fading Stars need urgent intervention\n", nrow(fading_stars)))
cat(sprintf("  ‚Ä¢ Average CLV: %s (guides acquisition spend)\n", 
            dollar(avg_clv, prefix = "¬£")))
cat(sprintf("  ‚Ä¢ Predicted 12M revenue: %s\n", 
            dollar(total_predicted_revenue, prefix = "¬£")))

cat("\nüí° NEXT STEPS:\n\n")
cat("  1. Implement tier-based retention strategies\n")
cat("  2. Launch Rising Stars acceleration program\n")
cat("  3. Execute Fading Stars win-back campaign\n")
cat("  4. Set CAC limits based on CLV analysis\n")
cat("  5. Integrate CLV into CRM for sales/service prioritization\n")
cat("  6. Monitor quarterly CLV changes and adjust strategies\n\n")

cat(rep("=", 70), "\n\n")
```

---

# Model Limitations & Caveats
```{r limitations}
cat("IMPORTANT LIMITATIONS TO NOTE:\n")
cat(rep("=", 70), "\n\n")

cat("1. ASSUMPTIONS:\n")
cat("   ‚Ä¢ Future retention follows historical patterns\n")
cat("   ‚Ä¢ No major external disruptions (economy, competition)\n")
cat("   ‚Ä¢ Customer behavior remains consistent\n")
cat("   ‚Ä¢ Business strategy and offerings stay similar\n\n")

cat("2. PREDICTION UNCERTAINTY:\n")
cat("   ‚Ä¢ Individual predictions have high variance\n")
cat("   ‚Ä¢ Aggregate forecasts more reliable than individual\n")
cat("   ‚Ä¢ Newer customers harder to predict (less history)\n")
cat("   ‚Ä¢ Long-term predictions less accurate\n\n")

cat("3. DATA LIMITATIONS:\n")
cat("   ‚Ä¢ Based on 12 months of historical data\n")
cat("   ‚Ä¢ Cannot predict life events affecting purchasing\n")
cat("   ‚Ä¢ No information on competitor actions\n")
cat("   ‚Ä¢ Marketing interventions will change behavior\n\n")

cat("4. RECOMMENDATIONS:\n")
cat("   ‚Ä¢ Update CLV predictions quarterly\n")
cat("   ‚Ä¢ Track actual vs predicted performance\n")
cat("   ‚Ä¢ Adjust model as you gather more data\n")
cat("   ‚Ä¢ Use as directional guide, not absolute truth\n")
cat("   ‚Ä¢ Combine with qualitative customer insights\n\n")

cat(rep("=", 70), "\n\n")
```

---

# Session Information
```{r session-info}
sessionInfo()
```

---

**‚úÖ CLV Prediction Analysis Complete!**

*This analysis enables data-driven customer acquisition, retention, and revenue forecasting.*